---
import Button from "../components/Button.astro"
---

<section class="p-16 text-theme-purple bg-theme-lights relative">
    <div class="grid grid-rows-12 grid-cols-24 w-full h-dvh mb-100 "  id="space-el">
        <img class="col-start-4 col-end-10 row-start-4 rounded-lg shadow-theme-box" src="/public/clients/happy-client-1.png" alt="Happy customer looking to the right">
        <img class="col-start-3 col-end-5 row-start-5 w-36 rounded-lg shadow-theme-box "  src="/public/clients/happy-client-2.png" alt="Happy customer with a big smile">
        <img class="col-start-9 col-end-11 row-start-3 w-32 rounded-lg shadow-theme-box" src="/public/clients/happy-client-3.png" alt="Happy customer laughing">
        <div class="col-start-9 row-start-8" id="anchor">
        <div class=" w-27 aspect-square  will-change-transform  bg-gradient-slogan rounded-lg" id="box-el"></div>
        </div>
        <div class="flex flex-col items-start justify-center col-start-14 col-end-17 row-start-6">
            <h1 class="title-secondary mb-8 w-90">
                    We turn complexity, uncertainty and raw ideas 
                    into solid, scalable 
                    digital products.
            </h1>
            <Button 
                href="",
                text="LetÂ´s grow",
                variant="lightSurface"
            />
        </div>
    </div>
</section>
<script>

import { gsap } from 'gsap'
import { Flip } from 'gsap/flip';
import { ScrollTrigger } from  'gsap/ScrollTrigger';

document.addEventListener("DOMContentLoaded", () => {
    gsap.registerPlugin( Flip, ScrollTrigger );

    let flipAnimation: gsap.core.Tween | gsap.core.Timeline | null = null;
    const space = document.getElementById('space-el');
    const objective = document.getElementById('slogan-box');
    const originalBox = document.getElementById('box-el');
    const anchor = document.getElementById('anchor');
    
    let pinnedClon: HTMLElement | null = null;
    let isClonActive = false;

    function createClon( ) {
        
        if (isClonActive) return; 
        if (!originalBox || !anchor || !space) return;

        const originalRect = originalBox.getBoundingClientRect( );
        let anchorRect = anchor.getBoundingClientRect( );

        pinnedClon = originalBox.cloneNode( true ) as HTMLElement;
        
        gsap.set( pinnedClon, {
            position: "fixed",
            left: originalRect.left,
            top: originalRect.top,
            width: originalRect.width,
            height: originalRect.height,
            willChange: "transform",
            zIndex: 1000
        });

        anchor.appendChild(pinnedClon);
        gsap.set(originalBox, { opacity: 0 });
        isClonActive = true;
        
        const state = Flip.getState( pinnedClon );

        gsap.set( pinnedClon, {
            width: "100%",
            height: space.offsetHeight,
            top: anchorRect.top,
            left: 0,
        });

        flipAnimation! = Flip.from(state, {
            duration: 1,
            ease: "power3.inOut",
            paused: true,
        });
    }

    function removeClon( ) {
        if (!isClonActive) return;
        if (pinnedClon) {
            pinnedClon.remove( );
            pinnedClon = null;
        }

        gsap.set( originalBox, { opacity: 1 });
        isClonActive = false;
        flipAnimation = null;
    }

    ScrollTrigger.create({
        trigger: "#space-el",
        start: "center center",
        onEnter: createClon,
        onEnterBack: createClon,
        onLeaveBack: removeClon,
    });

    ScrollTrigger.create({
        trigger: anchor, 
        start: "top center",
        end: ( ) => `+=${ space?.offsetHeight ?? 0 }`,
        scrub: true,
        onUpdate: (self) => {
            if ( flipAnimation ) {
                flipAnimation.progress(self.progress);
            }
            
            if ( self.progress >= 1 ) {
                gsap.set(pinnedClon!, { opacity: 0 });
                gsap.set(objective!, { opacity: 1 });
            } else {
                gsap.set(pinnedClon!, { opacity: 1 });
                gsap.set(objective!, { opacity: 0 });
            }
        }
    });
});
</script>